syntax = "proto3";
package agent;

// Deployment Event.
message Message {
  enum Type { PeerEvent = 0; LogEvent = 1; DeployEvent = 2; PeersFoundEvent = 3; PeersCompletedEvent = 4;}

  // Identifies which field is filled in.
  Type type = 1;
  Peer peer = 2;
  int64 ts = 3; // unix timestamp.

  oneof Event {
    // One of the following will be filled in.
    bool none = 4;
    int64 int = 5;
    Log log = 6;
    Deploy deploy = 7;
  }
}

message Deploy {
  enum Stage { Failed = 0; Deploying = 1; Completed = 2;}
  Stage stage = 1;
  Archive archive = 2;
  string error = 3;
}

message Log {
  string log = 1;
}

message UploadMetadata {
  uint64 bytes = 1;
}

message ArchiveChunk {
  bytes data = 1;
  bytes checksum = 2;
  oneof initialChunkMetadata {
    bool none = 3;
    UploadMetadata metadata = 4;
  }
}

message ArchiveResult {
  Deploy deploy = 1;
}

message Archive {
  bytes deploymentID = 1;
  Peer peer = 2;
  string location = 3;
  bytes checksum = 4;
  int64 ts = 5; // unix timestamp.
}

message StatusRequest {}
message Status {
  Peer Peer = 1;
  Deploy Latest = 2;
  repeated Archive Deployments = 3;
}

message DetailsRequest{}
message Details {
  bytes secret = 1;
  repeated Peer Quorum = 2;
  repeated Archive Deployments = 3;
}

message ConnectRequest {}
message ConnectInfo {
  bytes secret = 1;
  repeated Peer Quorum = 2;
}

message Peer {
  enum State { Node = 0; Client = 2; Gone = 3; }
  State Status = 1;
  string ip = 2;
  string name = 3;
  uint32 RPCPort = 4;
  uint32 RaftPort = 5;
  uint32 SWIMPort = 6;
  uint32 TorrentPort = 7;
}

message WatchRequest {}
message RecordResponse {}

service Quorum {
  rpc Upload(stream ArchiveChunk) returns (Archive) {}
  rpc Watch(WatchRequest) returns (stream Message) {}
  rpc Dispatch(stream Message) returns (RecordResponse) {}
  rpc Deploy(ProxyDeployRequest) returns (ProxyDeployResult) {}
}

message ShutdownRequest{}
message ShutdownResponse{}

service Agent {
  rpc Connect(ConnectRequest) returns (ConnectInfo) {}
  rpc Deploy(Archive) returns (ArchiveResult) {}
  rpc Info(StatusRequest) returns (Status) {}
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse) {}
}

message ProxyDeployRequest {
  Archive archive = 1;
  int64 concurrency = 2;
  repeated Peer peers = 3;
}
message ProxyDeployResult {}
